files:
  "/opt/aws/amazon-cloudwatch-agent/bin/config-template.json":
    mode: "000644"
    owner: root
    group: root
    content: |
      {
        "logs": {
          "logs_collected": {
            "files": {
              "collect_list": [
                {
                  "file_path": "/var/log/containers/laravel/laravel.log",
                  "log_group_name": "/aws/elasticbeanstalk/${EB_ENVIRONMENT_NAME}/var/log/containers/laravel",
                  "log_stream_name": "{instance_id}",
                  "timestamp_format": "%Y-%m-%d %H:%M:%S %z",
                  "multi_line_start_pattern": "^\\[\\d{4}-\\d{2}-\\d{2}",
                  "timezone": "LOCAL"
                },
                {
                  "file_path": "/var/log/containers/laravel/worker-high.log",
                  "log_group_name": "/aws/elasticbeanstalk/${EB_ENVIRONMENT_NAME}/var/log/containers/laravel",
                  "log_stream_name": "{instance_id}-worker-high",
                  "timestamp_format": "%Y-%m-%d %H:%M:%S %z",
                  "multi_line_start_pattern": "^\\[\\d{4}-\\d{2}-\\d{2}",
                  "timezone": "LOCAL"
                },
                {
                  "file_path": "/var/log/containers/laravel/worker-medium.log",
                  "log_group_name": "/aws/elasticbeanstalk/${EB_ENVIRONMENT_NAME}/var/log/containers/laravel",
                  "log_stream_name": "{instance_id}-worker-medium",
                  "timestamp_format": "%Y-%m-%d %H:%M:%S %z",
                  "multi_line_start_pattern": "^\\[\\d{4}-\\d{2}-\\d{2}",
                  "timezone": "LOCAL"
                },
                {
                  "file_path": "/var/log/containers/laravel/short-schedule.log",
                  "log_group_name": "/aws/elasticbeanstalk/${EB_ENVIRONMENT_NAME}/var/log/containers/laravel",
                  "log_stream_name": "{instance_id}-scheduler",
                  "timestamp_format": "%Y-%m-%d %H:%M:%S %z",
                  "multi_line_start_pattern": "^\\[\\d{4}-\\d{2}-\\d{2}",
                  "timezone": "LOCAL"
                }
              ]
            }
          }
        }
      }

container_commands:
  01_create_log_dir:
    command: "mkdir -p /var/log/containers/laravel"
  02_set_log_permissions:
    command: "chmod -R 777 /var/log/containers/laravel"
  03_set_log_ownership:
    command: "chown -R webapp:webapp /var/log/containers/laravel"
  04_get_eb_environment_name:
    command: |
      #!/bin/bash
      # 從 EB 容器配置中獲取環境名稱
      EB_ENVIRONMENT_NAME=$(/opt/elasticbeanstalk/bin/get-config container -k environment_name)
      # 使用 envsubst 替換配置文件中的變數
      export EB_ENVIRONMENT_NAME
      envsubst < /opt/aws/amazon-cloudwatch-agent/bin/config-template.json > /opt/aws/amazon-cloudwatch-agent/bin/config.json
  05_start_cloudwatch_agent:
    command: sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json

packages:
  yum:
    gettext: []